{% extends 'base.html' %}
{% load dashboard_extras %}
{% block title %}Tableau de bord{% endblock %}

{% block content %}
    <div class="dashboard-container">        
        
        <main class="main-content">
            <h2>Statistiques rapides</h2>
            <div class="stats-overview">
                <div class="stat-box">
                    <h3>Total Réservations</h3>
                    <p>{{ total_reservations }}</p>
                </div>
                <div class="stat-box">
                    <h3>Total Utilisateurs</h3>
                    <p>{{ total_users }}</p>
                </div>
                <div class="stat-box">
                    <h3>Trajets à venir</h3>
                    <p>{{ upcoming_trips }}</p>
                </div>
            </div>

            <section class="recent-reservations">
                <h3>Réservations récentes</h3>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Client</th>
                            <th>Trajet</th>
                            <th>Date départ</th>
                            <th>Date réservation</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for reservation in recent_reservations %}
                        <tr>
                            <td>{{ reservation.id }}</td>
                            <td>{{ reservation.user.username }}</td>
                            <td>{{ reservation.departure.trip.origin }} → {{ reservation.departure.trip.destination }}</td>
                            <td>{{ reservation.departure.date }} {{ reservation.departure.time|time:'H:i' }}</td>
                            <td>{{ reservation.booked_at|date:'d/m/Y' }} à {{ reservation.booked_at|time:'H:i' }}</td>
                            <td>{% if reservation.status == 'P' %}En attente{% elif reservation.status == 'C' %}Confirmée{% elif reservation.status == 'X' %}Annulée{% endif %}</td>
                            <td>
                                {% if reservation.status == 'P' %}
                                    <form method="post" action="{% url 'dashboard:reservation_confirm' reservation.id %}" style="display:inline;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-success">Confirmer</button>
                                    </form>
                                {% endif %}
                                <a href="{% url 'dashboard:reservation_edit' reservation.id %}" class="btn btn-sm btn-warning">Modifier</a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="7">Aucune réservation récente.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
                <a href="{% url 'dashboard:reservation_list' %}" class="btn">Voir toutes les réservations</a>
            </section>

            <section class="upcoming-departures">
                <h3>Départs prévus sur 7 jours</h3>
                {% for date in date_range %}
                    <div class="date-group">
                        <h4>{{ date|date:"l d F Y" }}</h4>
                        <table>
                            <thead>
                                <tr>
                                    <th>Trajet</th>
                                    <th>Heure</th>
                                    <th>Bus</th>
                                    <th>Places disponibles</th>
                                    <th>Taux d'occupation</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>                            <tbody>
                                {% with date_str=date|date:"Y-m-d" %}
                                {% with departures=departures_by_date|slice:"0:2"|get:date_str %}
                                {% for departure_info in departures|default_if_none:empty %}
                                <tr class="{% if departure_info.available_seats <= 5 %}warning{% endif %}">
                                    <td>{{ departure_info.departure.trip.origin }} → {{ departure_info.departure.trip.destination }}</td>
                                    <td>{{ departure_info.departure.time|time:"H:i" }}</td>
                                    <td>{{ departure_info.departure.bus.name }} ({{ departure_info.departure.bus.capacity }} places)</td>
                                    <td>{{ departure_info.available_seats }}</td>
                                    <td>{{ departure_info.occupancy_rate|floatformat:1 }}%</td>
                                    <td>
                                        <a href="{% url 'dashboard:departure_edit' departure_info.departure.id %}" class="btn btn-sm">Modifier</a>
                                        {% if not departure_info.departure.is_active %}
                                        <span class="badge badge-warning">Désactivé</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6">Aucun départ prévu pour cette date.</td>
                                </tr>                                {% endfor %}
                                {% endwith %}{% endwith %}
                            </tbody>
                        </table>
                    </div>
                {% endfor %}
                <div class="actions">
                    <a href="{% url 'dashboard:departure_add' %}" class="btn btn-primary">Ajouter un départ</a>
                    <a href="{% url 'dashboard:departure_list' %}" class="btn">Voir tous les départs</a>
                </div>
            </section>

            {% if recent_messages %}
            <section class="recent-messages">
                <h3>Messages récents</h3>
                <table>
                    <thead>
                        <tr>
                            <th>De</th>
                            <th>Email</th>
                            <th>Date</th>
                            <th>État</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for message in recent_messages %}
                        <tr>
                            <td>{{ message.name }}</td>
                            <td>{{ message.email }}</td>
                            <td>{{ message.submitted_at|date:'d/m/Y H:i' }}</td>
                            <td>{% if message.replied_at %}Répondu{% else %}En attente{% endif %}</td>
                            <td>
                                <a href="{% url 'dashboard:message_reply' message.id %}" class="btn btn-sm">{% if message.replied_at %}Voir{% else %}Répondre{% endif %}</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <a href="{% url 'dashboard:message_list' %}" class="btn">Voir tous les messages</a>
            </section>
            {% endif %}
        </main>
    </div>

    
{% endblock %}
